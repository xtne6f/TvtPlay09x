TVTest TvtPlay Plugin ver.0.9r4 + BonDriver_Pipe.dll + TvtAudioStretchFilter.ax

■概要
TVTest付属のBonDriver_UDPまたは専用のBonDriver_Pipeを使ってローカルTSファイルを
再生するプラグインです。

■動作環境
・Windows XP以降(ただしVistaは未確認)
・TVTest ver.0.7.16 以降、or対応するTVH264
・通常版: Visual C++ 2005 SP1 再頒布可能パッケージ(TVTestが起動するなら入ってる)
・x64版:  Visual C++ 2010 SP1 再頒布可能パッケージ (x64)
          # ↑ver.0.9以降、x64版はSP1の方をインストールする必要があるので注意

■ver.0.9r3からの移行
・TvtPlay.tvtpを置きかえてください。

■ver.0.9、ver.0.9r2からの移行
・TvtPlay.tvtpとTvtAudioStretchFilter.axを置きかえてください。

■以前のバージョン(～ver.0.8r2)からの移行
・TvtPlay.tvtpとBonDriver_Pipe.dllとTvtAudioStretchFilter.axとを置きかえてくださ
  い。設定ファイルはそのまま引き継げます。
・ver.0.9ではBonDriver_Pipe.dllに倍速再生に関する修正があります。必ず置き換えて
  ください。
・ver.0.9r3ではTvtAudioStretchFilter.axに変更があります(後述の「
  TvtAudioStretchFilterの追加機能」を参照)。必要ならば置き換えてください。
・ver.0.9ではデフォルトのアイコンデザインが一部変わりました。設定キーのButton04
  ～Button15を一度削除すると新しいデザインになります。
・ver.0.8では倍速再生ボタン2個が追加されました。アイコン画像をカスタマイズしてい
  る方は画像の編集が必要になるかもしれません。

■使い方
TVTestのPluginsフォルダにTvtPlay.tvtpを入れてください。BonDriver_Pipe.dllは使用
しないならば捨ててください(後述の「BonDriver_Pipe.dllについて」を参照)。なお、
TvtPlay(x64).tvtpはx64版のTVTest利用者向けです。

TVTest起動オプションの最後に拡張子.ts .m2t .m2ts いずれかのファイルパスを付加す
るとプラグインは有効になり、起動時にそのファイルを開きます。起動オプションについ
ては後述の「TVTest起動オプションについて」も参照してください。
例:
  TVTest.exe /d BonDriver_UDP.dll foo.ts
  # TVTestのデフォルトのBonDriverに"BonDriver_UDP.dll"を指定している場合、
  # /d BonDriver_UDP.dllは不要

起動するとTVTestウインドウ下部にコントロールが表示されます。デザイン的にTVTestの
ウインドウ枠を細くすることをお勧めします。コントロール左側の11個のボタンは左から
、ファイルを開く、シーク-60秒/-15秒/-5秒、一時停止、シーク5秒/15秒/60秒、ファイ
ル末尾へシーク、倍速再生200%/50%、です。なお、ファイルを開くボタンを右クリックす
ると、TVTestの録画フォルダにある.tsファイルを簡易表示します。コントロール中央は
シークバーになっていて、左クリックで任意の位置にシーク、右クリックで再生を一時停
止/再開します。コントロール右側には再生位置および総再生時間が表示されます。

倍速再生を利用する方は音声フィルタの設定が必要です。倍速再生はBonDriver_Pipe.dll
の使用をお勧めします。同梱のDirectshowフィルタTvtAudioStretchFilter.axを適当なフ
ォルダに入れ、コマンドプロンプトから管理者権限で regsvr32 {フィルタのパス} と入
力してください(この辺は「DirectShowフィルタ 登録」あたりでググってください)。無
事登録されていれば、TVTestの設定->再生->音声フィルタにこのフィルタが現れるので、
これを選択してください。

*** 以下、必要に応じてお読みください ***

■BonDriver_Pipe.dllについて
BonDriver_UDPのプロセス間通信方式をパイプに改変したものです。転送中にドロップし
ないのと、UDP/IPのスタックを介さないので軽い(はず…)のが利点です。興味のある方は
使ってみてください。TVTestに対してはBonDriver_UDPのフリをするので、BonDriver_UDP
と同じ要領で使ってください。BonDriver_UDPと同時使用もできます。
導入にはVisual C++ 2005 SP1 再頒布可能パッケージ(x64版はVisual C++ 2010 SP1 再頒
布可能パッケージ (x64))が必要です。x64版はファイル名を必ず"BonDriver_Pipe.dll"に
リネームしてください。

■TVTest起動オプションについて
TVTest起動時につぎのようなオプションを追加することで、プラグインの有効・無効の自
動化などが可能です。
/tvtpudp          BonDriver_UDP.dllの使用の有無でプラグインを有効・無効にする
/tvtpudp /tvtplay 上述の動作＋ファイルパスの拡張子を問わない
/tvtpipe          BonDriver_Pipe.dllについて/tvtpudpと同様(同時指定もできる)
/tvtplay          起動時にプラグインを有効化＋ファイルパスの拡張子を問わない
オプションは複数起動禁止のTVTest起動中に追加できます(削除はできません)

■倍速再生について
倍速再生は音声を伸び縮みさせることで実現しています。動画をスキップさせているわけ
ではないので、速度に応じてシステムの負荷が高まります。また、BonDriver_UDP.dllを
使っている場合や、動画にドロップやエラーのある箇所では、あまり高速に再生すると数
秒～数十秒間TVTestが固まるようです。しばらく放っておけば戻りますが、あまり再生速
度を上げすぎないように注意してください。
また、倍速再生に使用するTvtAudioStretchFilterですが、倍速再生時以外は何も処理を
しない(Waveデータを通過させるだけ)ので、このフィルタを設定するだけで負荷が上がっ
たりすることはおそらく無いです。

■TvtAudioStretchFilterの追加機能
TVTestの音声フィルタを一つしか指定できないことへの対策として、ver.0.9r3以降に添
付のTvtAudioStretchFilterでは、接続するDirectShowフィルタを1つだけ指定できるよう
になりました。たとえば、フィルタを置いたフォルダに"TvtAudioStretchFilter.ini"を
次のような内容で作成すると、(ffdshowがインストールされていれば)このフィルタの後
続にffdshow Audio Decoderが接続されます。

[TvtAudioStretchFilter]
AddFilter={0F40E1E5-4F79-4988-B1A9-CC98794E6B55}

(エラーメッセージ)
  「追加のフィルタを生成できません。」
  AddFilterに指定したDirectShowフィルタが見つからなかったときに表示されます。
  
  「追加のフィルタを接続できません。」
  おもにフィルタの入出力ピンがPCM形式をサポートしていない(たとえばffdshow Audio
  Decoderの設定で"Uncompressed"形式を有効にしていないなど)ときに表示されます。

(上級者向け)
  一般に1入力1出力のPCM音声フィルタであれば(おそらく)何でも追加できます。
  AddFilterにはDirectShowフィルタのクラス識別子(CLSID)を指定してください。CLSID
  はGraphEditを使うか、レジストリキーHKEY_CLASSES_ROOT\CLSID内部をフィルタ名(
  FriendlyName)で検索すれば取得できます。
  フィルタをどのように追加するかは、GraphEditで観察するとよく分かると思います。

■容量確保録画中の追っかけ再生について
ファイル末尾(2秒ぐらい)に有効なTSデータがないとき、そのファイルはEpgDataCap_Bon
やRecTaskのようなファイル容量確保型の録画中であると判断します。このようなファイ
ルの追っかけ再生時にはコントロールの総再生時間の右隣に'*'が表示されます(通常の追
っかけ再生は'+')。また、総再生時間はファイルサイズが初めて減少するタイミングまで
増加し続けます。さらに、以下のような制約があります。
・ファイル末尾へのシークボタン・コマンドは機能しない
・再生時間外の位置へシークしようとすると、一度ファイル先頭に戻る
・再生時間ぎりぎりの位置へ一気にシークしようとすると、ファイル先頭に戻る場合があ
  る(概算シーク中に再生時間外の位置へシークしてしまうため)
ver.0.8r2以降で対応した新機能のため、今後の更新や動作報告に注意してください。

■設定ファイルについて
設定ファイル"TvtPlay.ini"は初回使用時プラグインフォルダに自動作成されます。必要
な場合はこれを直接編集してカスタマイズしてください。以下は設定キーの説明です。

TsAutoClose / TsAutoLoop
    末尾まで再生後にファイルを閉じる/先頭に戻る[=1]かどうか
    # 追っかけ再生中は発動しません。
TsResetAllOnSeek
    シーク時にビューアリセットではなく全体リセットをかける[=1]かどうか
TsResetDropInterval【ver.0.5～】
    シーク後にドロップカウントをリセットするために監視する間隔(ミリ秒)、またはリ
    セットしない[=0]
    # シーク後、ドロップカウントの増加が止まれば値をリセットします。
    # 後述の「ドロップカウントについて」も参照
TsThreadPriority【ver.0.7～】
    TSデータの転送スレッドの優先度
    # 通常は変更する必要はありません。
    # システム高負荷時に音声がとぎれたりする場合には、"TVTest.ini"設定ファイルの
    # StreamThreadPriority(「ストリームスレッドの優先度」の設定値)と同じ値にする
    # と改善するかもしれません。
TsStretchMode【ver.0.8～】
    倍速再生モードを指定
    # [=1]再生速度だけ調整します(速度に応じて音が高くなったりします)
    # [=2]ピッチだけ上げ下げします(用途不明)
    # [=3]ピッチと再生速度の両方を調整します
TsStretchNoMuteMax / TsStretchNoMuteMin【ver.0.8～】
    倍速再生の速度が設定値以上/以下なら無音にする
TsConvTo188【ver.0.9～】
    192ByteTS(Timestamped TS)の場合、188ByteTSに変換して転送する[=1]かどうか
ToBottom
    フルスクリーン時、コントロールの位置を画面のもっとも下に置く[=1]かどうか
Margin【ver.0.6～】
    コントロールの外枠(黒い部分)のピクセル幅
    # デフォルトはTVTest ver.0.7.21以降で[=1]、それ以外は[=2]
    # 0.7.21以降で対応したウインドウ枠をなくすスタイルにも対応[=0]
DispTot【ver.0.5～】
    シークバーに放送時刻を表示する[=1]かどうか
DispTotOnStatus【ver.0.5～】
    再生位置の表示の隣に放送時刻を表示する[=1]かどうか
StatusItemWidth【ver.0.5～】
    再生位置・総再生時間の表示部分のピクセル幅
    # 放送時刻を表示する場合は[=140]程度にするとよいです。
TimeoutOnCommand / TimeoutOnMouseMove
    フルスクリーン時、キーコマンド/マウス操作をおこなった後にコントロールを表示
    する時間をミリ秒で指定、または表示しない[=0]
Salt【ver.0.7～】
    0～65535のランダムな値
    # 特にユーザがいじる必要はありません
FileInfoMax【ver.0.7～】
    レジューム情報を記録する最大数、または記録しない[=0]
    # 扱うTSファイルの数より大きくしておけば忘れられることはないでしょう
PopupMax【ver.0.8～】
    フォルダの簡易表示機能でファイルを一覧表示する最大数、またはこの機能を使わな
    い[=0]
    # 最大値は[=100]です。
PopupDesc【ver.0.9～】
    簡易表示機能でファイルを降順表示する[=1]かどうか
PopupPattern【ver.0.8～】
    簡易表示機能で表示するフォルダを指定
    # たとえば[=D:\media\*.ts]とすれば"D:\media"フォルダにある.tsファイルが名前
    # 順にポップアップ表示されます。
    # %RecordFolder% はTVTestの録画フォルダに置き換わります。
IconImage
    アイコン画像を絶対パスかTVTestフォルダからの相対パスで指定
    # プラグインに内蔵されている"src/Buttons.bmp"の画像を置き換えます。高さ16px
    # のモノクロBMPファイルを指定してください。
Seek[A-H]
    シーク時間をミリ秒で指定する
    # ボタンコマンドやキー割り当ての"シーク:A"～"シーク:H"に対応します。
Stretch[A-D]【ver.0.8～】
    倍速再生の速度を、等速にたいする比率(パーセント)で指定する
    # [=25]～[=800]まで設定可能です。
Button[00-15]
    ボタンのアイコン番号とボタンコマンドを指定する
    # フォーマットは"{アイコン番号},{ボタンコマンド(Open,Closeなど)}"
    # ';'でコメントアウトするか何も指定しなければそのボタンは消えます。
    # 並べ替えもできます。
    # アイコン画像の X座標=(アイコン番号)×16 の位置をアイコンとして使用します。
    # ただし、左上1pxが黒色ならば幅16pxを最大とする可変ピッチです【ver.0.9～】。
    # PauseとLoopとStretch[A-D]は、切り替えのため右隣のアイコンも使います。
    # "{アイコン番号}"のフォーマットについて【ver.0.9～】
    # ・アイコン番号を複数指定(-でつなげる)して、アイコンを合成できます。
    # ・'があれば、続く1文字のASCIIコードをアイコン番号に置き換えます。
    # ・~があれば、以降を画素反転して合成します。
    # ・:があれば、以降は切り替え時のアイコンを合成します。
    # 例:
    #   [ +5m] '+'5-59
    #   [-300] '-23-20-20
    #   [ 35%] '3'5'%:30~'3'5'%

[FileInfo]セクション【ver.0.7～】
    レジューム情報のリスト
    # TSファイルの先頭2キロバイトとSaltから得られたハッシュ値と、そのファイルの
    # レジューム位置(ミリ秒)の対応データが書き込まれます。
    # 対応データは使われなかった順に消えていきます。
    # 元のTSファイルがなければ、どのようなファイルを開いたかを特定されることはあ
    # りません。

[ColorScheme]および[Style]セクション【ver.0.9～】
    セクションがあれば、デザインをプラグインで個別に設定する
    # TvtPlayは、起動時に"TVTest.ini"からこれらのセクションを読みこんでコントロ
    # ールのデザインを設定していますが、これを個別に設定できます。おもにTVTest本
    # 体の仕様変更への保険を目的としています。

■ドロップカウントについて
シークを行うとTVTestステータスバーのドロップカウントは増加します。これはTSパケッ
トの巡回カウンタ(continuity counter)が不連続になるためで、正常な動作です。
また、この巡回カウンタは重畳するパケットのPIDごとにカウントアップしていくので、
送出頻度の低いパケット(EITやTOTなど)はドロップ判定が遅れます。シーク数秒～十数秒
後にドロップカウントがいくらか増えることがあるのは、おそらくこれが原因です。この
挙動が気持ちわるいひとはTsResetAllOnSeekを1にするかTsResetDropIntervalを大きめの
値(2000～4000程度)にしてみてください。

■仕様
・TVTest ver.0.7.20以前では、シーク後に音無しor映像無しになることがあります。当
  方ではシーク200回のうち7回発生しました。発生したときはビューアリセットしたりも
  う一度シークしたりしてください。
・総再生時間の表示は数秒以内の誤差がでる場合があります。また、総再生時間はファイ
  ル先頭および末尾の情報から算出した値なので、カット編集されている場合は不正確に
  なります
・26.5時間以上のTSファイルはおそらく正しく再生できません(Program Clock Reference
  が巡回する関係上)
・再生位置から一度に13.2時間以上離れた位置にシークすると、誤った位置に飛びます
・追っかけ再生に対応しています
・追っかけ再生中の総再生時間は推計です
・勢いでつくったので不具合もけっこうあるかも

■ソースについて
当プラグインの作成に当たり、EpgDataCap_BonのEpgTimerPlugInを参考にしました。また
、TSファイルの同期・解析のために、tsselect-0.1.8(
http://www.marumo.ne.jp/junk/tsselect-0.1.8.lzh)よりソースコードを改変利用してい
ます。
TvtAudioStretchFilterフィルタは、再生レート制御のために、SoundTouchライブラリver
.1.6.0(http://www.surina.net/soundtouch/)を利用しています。
デフォルトのアイコン画像"Buttons.bmp"は、「HDUS関係ファイル置き場」(
http://2sen.dip.jp/)のup0598.zip「非公式 TvtPlayシークボタンカスタマイズ用アイコ
ン 修正2」のデザインをもとに作成しています。
また、おもにTVTest ver.0.7.23からソースコードを流用しています。特に以下のファイ
ルはほぼ改変なしに流用しています(差分は"diff_TVTestStatusView_orig.txt"を参照)
  "Aero.cpp"
  "Aero.h"
  "BasicWindow.cpp"
  "BasicWindow.h"
  "ColorScheme.cpp"
  "ColorScheme.h"
  "DrawUtil.h"
  "DrawUtil.cpp"
  "Settings.cpp"(From: ver.0.7.21r2)
  "Settings.h"(From: ver.0.7.21r2)
  "StatusView.cpp"
  "StatusView.h"
  "Theme.cpp"
  "Theme.h"
  "WindowUtil.cpp"
  "WindowUtil.h"
ソースコメントに流用元を記述しています。流用部分については流用元の規約に注意し、
その他の部分は勝手に改変・利用してもらって構いません。

■更新履歴
ver.0.9r4 (2011-11-09)
・「ファイルを開く」ダイアログ使用後にカレントディレクトリが変更されてしまうのを
  修正
・ver.1.x系に合わせて読み取り可能なButton[00-15]の最大文字列長を64→128に変更
・ver.1.x系に合わせてコンパイルオプション見直しでバイナリサイズ縮小
ver.0.9r3 (2011-10-20)
・TVTest ver.0.7.23でボーダーの配色方法が微妙に変化したので追随
・"TVTest.ini"の読み込み部分を0.7.21r2ベースに戻して軽量化+今後のTVH264に対応
・"TvtPlay.ini"のFileInfoセクションの読み込み部分を効率化
・TvtAudioStretchFilterに機能追加
・ver.1.0は人柱版になるかもしれない(ならないかもしれない)
ver.0.9r2 (2011-10-03)
・ドライバ変更時のチャンネル設定の問題が解決されたので、TVTest ver.0.7.22以降に
  ついて、ver.0.8r2での仮対応を元にもどした
・TVTestのINI読み書き方法の変更により、デザインを適用できないことがあるのを修正
・書き込みを参考に簡易一覧表示のキー割り当てを「ファイルを開く(ポップアップ)」の
  みにもどした(もう一回押すと閉じる)
・プラグインの説明(設定->プラグイン->一覧)にバージョンを表記するようにした
ver.0.9 (2011-10-02)
・2sen(hdusup)のup0598を可変ピッチにして流用し、アイコン合成できるようにした
  ・デザインされた方、感謝します
・192ByteTSを188ByteTSに変換して転送できるようにした
・容量確保録画の追っかけ時に総再生時間-3秒に達したら等速再生に戻すようにした
・降順に簡易一覧表示できるようにした
・簡易一覧表示をリモコン操作できるようにした
  ・ちゃんとできるか不明、レスを待ちます
・コントロールのデザインを独自に設定できるようにした
・倍速再生時のフリーズを軽減した
ver.0.8r2 (2011-09-20)
・"倍速再生"の方が正しそうなので用語をあらためた
・容量確保録画の追っかけ再生を考慮した
・フルスクリーン時のマルチディスプレイでの動作、以下2点を修正した
  ・縦サイズが異なるモニタを使っている場合
  ・全画面切り替え時にバーが画面外にいる場合
・複数起動禁止時の起動オプションからのUDP/Pipeへのドライバ変更時、チャンネルセッ
  トするようにした(問題が解決するまでの仮対応)
・簡易一覧表示のポップアップをキー割り当て可能にした
  ・リモコン対応は次バージョン以降
ver.0.8 (2011-09-16)
・早送り機能を追加した
・指定フォルダの簡易一覧表示を追加した
ver.0.7 (2011-09-02)
・移動・リサイズで意味もなくコントロールをアクティブにしてたのを修正
  ・スレで指摘してくれた方、感謝です
・ループ再生時、再生終了後に1秒弱待つようにした
・フルスクリーン時にコントロールを出すとマルチメディアキーが効かなくなるのを修正
・最大化時のコントロールの位置をちょっと工夫した
・放送時刻表示がいまいち見づらかったので書きこみを参考に微調整
・x64版を追加した(Windows7でしかテストしてない)
・設定キーTsThreadPriorityを追加した
・オプション/tvtpudp /tvtpipeを追加した
・簡単なレジューム機能をつけた
ver.0.6 (2011-08-29)
・デッドロックの問題が解決されたので、TVTest ver.0.7.21以降についてビューアリセ
  ットをシーク直前からシーク後にもどした
・ver.0.7.21以降のウインドウ枠に対応、設定キー Margin を追加
・GUIまわりのTVTestからの流用コードについて、ver.0.7.21での修正分をマージ
・基本機能がそろったのでver.0.xの機能追加は停止
  ・おもにバグ修正のみになります
  ・つぎに機能追加するときはver.1.xの人柱版になる予定です
ver.0.5 (2011-08-27)
・対応するTVTestをver.0.7.16に引き上げた(実際にはTvtPlay0.3からこうだった)
・ファイルを開きなおしたときに再生ボタンを再描画していなかったのを修正
・通常表示のときコントロール下部のマージンが1px少なくなってたのを修正
・シーク後にドロップカウントをリセットするようにした
・BonDriver_Fileのソースを参考にPCRの取得部分をより合理的にした
  ・ソースの保管場所書きこんでくれた方サンクスです
・Time Offset Tableをもとに放送時刻を表示可能にした(個人的な需要)
・TVTestに合わせて最終ビルドをVisualC++2005(EE)にして/MT→/MDに変更
ver.0.4 (2011-08-23)
・人柱版表記をはずした(人柱さん達に感謝!)
・ボタンとシーク量、ほか細かい部分をカスタマイズ可能にした
・一時停止後も少しだけ再生が進んでしまうのを改善
・BonDriver_Pipeのパイプのバッファ量を効率的な値に修正
ver.0.3 (2011-08-20)
・スレッドの要望をもとに3点を追加した
  ・複数起動禁止時に複数起動されたとき、ファイルを開きなおすようにした
  ・追っかけ再生時、総再生時間の右端に'+'を付けた
  ・1時間未満の時刻表示を簡略化
・ストリームのアンダーランを抑制する微調整
・一時停止からの復帰時にカクつく場合があったのを修正
・BonDriver_Pipeつくってみた
・マルチディスプレイに対応できてなかったようなので修正(できたかな…)
ver.0.2 (2011-08-16)
・下記の修正では修正できてなかったため、さらに差し替えました
  ・修正分は"diff_02r1_02r2.txt"を参照
ver.0.2 (2011-08-15)
・バグ発見のため15日21時頃に差し替えました
  ・ファイルパス付で起動すると起動時にフリーズする不具合を修正(TVTestの起動完了
    を待たずにRESET_VIEWERを発行したため、TVTest内部でデッドロックした模様)
・スレッドで要望のあったもののうち、とりあえず容易な2点を追加した
  ・プラグインが有効なときはファイルをドラッグ&ドロップできるようにした
  ・キー割り当てを追加した
・コントロールの描画をすこし修正
・マルチディスプレイに対応したかもしれない(環境が無いので…)
ver.0.1 (2011-08-13)
・初版
